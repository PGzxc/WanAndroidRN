{"version":3,"names":["arrayRemove","isString","useForceRender","usePrevious","React","Children","cloneElement","useRef","exitableByKey","children","map","Map","forEach","child","key","props","exit","set","AnimatePresence","fr","childArr","toArray","childrenPrevious","childrenByKey","childrenByKeyPrevious","exiting","prevChild","get","current","childrenToRender","delete","index","indexOf","splice","animKeys","Object","keys","animate","onAnimationComplete","animKey","has","length"],"sources":["AnimatePresence.tsx"],"sourcesContent":["import { arrayRemove, isString } from '@legendapp/tools';\nimport { useForceRender, usePrevious } from '@legendapp/tools/react';\nimport React, { Children, cloneElement, Key, ReactElement, ReactNode, useRef } from 'react';\n\ninterface Props {\n    children: ReactNode;\n}\n\nfunction exitableByKey(children: ReactNode[]) {\n    const map = new Map<Key, ReactElement>();\n    Children.forEach(children, (child: ReactElement) => {\n        if (child.key && child.props?.exit && isString(child.key)) {\n            map.set(child.key, child);\n        }\n    });\n    return map;\n}\n\nexport function AnimatePresence({ children }: Props) {\n    const fr = useForceRender();\n    const childArr = Children.toArray(children);\n    const childrenPrevious = usePrevious(childArr);\n\n    // Map children and previous children to { key: child }\n    const childrenByKey = exitableByKey(childArr);\n    const childrenByKeyPrevious = usePrevious(childrenByKey);\n\n    // Add newly exited elements to the exiting map\n    const exiting = useRef(new Map<Key, ReactElement>());\n    if (childrenByKeyPrevious) {\n        childrenByKeyPrevious.forEach((prevChild, key) => {\n            if (!childrenByKey.get(key)) {\n                exiting.current.set(key, prevChild);\n            }\n        });\n    }\n\n    // Render exiting elements into the position they were previously\n    let childrenToRender = [...childArr];\n    exiting.current.forEach((child, key) => {\n        if (childrenByKey.get(key)) {\n            exiting.current.delete(key);\n        } else {\n            const index = childrenPrevious.indexOf(child);\n            childrenToRender.splice(index, 0, child);\n        }\n    });\n\n    return (\n        <>\n            {childrenToRender.map((child: ReactElement) => {\n                if (child && child.props.exit) {\n                    const key = child.key;\n                    const animKeys = Object.keys(child.props.exit);\n                    // Remove the child when all exit animations end\n                    return key && exiting.current.get(key) && animKeys\n                        ? cloneElement(child, {\n                              animate: child.props.exit,\n                              onAnimationComplete: (animKey) => {\n                                  if (exiting.current.has(key)) {\n                                      arrayRemove(animKeys, animKey);\n                                      if (animKeys.length === 0) {\n                                          exiting.current.delete(key);\n                                          fr();\n                                      }\n                                  }\n                              },\n                          })\n                        : child;\n                }\n                return child;\n            })}\n        </>\n    );\n}\n"],"mappings":"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"}