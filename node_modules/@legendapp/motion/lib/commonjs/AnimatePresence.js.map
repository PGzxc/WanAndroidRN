{"version":3,"names":["exitableByKey","children","map","Map","Children","forEach","child","key","props","exit","isString","set","AnimatePresence","fr","useForceRender","childArr","toArray","childrenPrevious","usePrevious","childrenByKey","childrenByKeyPrevious","exiting","useRef","prevChild","get","current","childrenToRender","delete","index","indexOf","splice","animKeys","Object","keys","cloneElement","animate","onAnimationComplete","animKey","has","arrayRemove","length"],"sources":["AnimatePresence.tsx"],"sourcesContent":["import { arrayRemove, isString } from '@legendapp/tools';\nimport { useForceRender, usePrevious } from '@legendapp/tools/react';\nimport React, { Children, cloneElement, Key, ReactElement, ReactNode, useRef } from 'react';\n\ninterface Props {\n    children: ReactNode;\n}\n\nfunction exitableByKey(children: ReactNode[]) {\n    const map = new Map<Key, ReactElement>();\n    Children.forEach(children, (child: ReactElement) => {\n        if (child.key && child.props?.exit && isString(child.key)) {\n            map.set(child.key, child);\n        }\n    });\n    return map;\n}\n\nexport function AnimatePresence({ children }: Props) {\n    const fr = useForceRender();\n    const childArr = Children.toArray(children);\n    const childrenPrevious = usePrevious(childArr);\n\n    // Map children and previous children to { key: child }\n    const childrenByKey = exitableByKey(childArr);\n    const childrenByKeyPrevious = usePrevious(childrenByKey);\n\n    // Add newly exited elements to the exiting map\n    const exiting = useRef(new Map<Key, ReactElement>());\n    if (childrenByKeyPrevious) {\n        childrenByKeyPrevious.forEach((prevChild, key) => {\n            if (!childrenByKey.get(key)) {\n                exiting.current.set(key, prevChild);\n            }\n        });\n    }\n\n    // Render exiting elements into the position they were previously\n    let childrenToRender = [...childArr];\n    exiting.current.forEach((child, key) => {\n        if (childrenByKey.get(key)) {\n            exiting.current.delete(key);\n        } else {\n            const index = childrenPrevious.indexOf(child);\n            childrenToRender.splice(index, 0, child);\n        }\n    });\n\n    return (\n        <>\n            {childrenToRender.map((child: ReactElement) => {\n                if (child && child.props.exit) {\n                    const key = child.key;\n                    const animKeys = Object.keys(child.props.exit);\n                    // Remove the child when all exit animations end\n                    return key && exiting.current.get(key) && animKeys\n                        ? cloneElement(child, {\n                              animate: child.props.exit,\n                              onAnimationComplete: (animKey) => {\n                                  if (exiting.current.has(key)) {\n                                      arrayRemove(animKeys, animKey);\n                                      if (animKeys.length === 0) {\n                                          exiting.current.delete(key);\n                                          fr();\n                                      }\n                                  }\n                              },\n                          })\n                        : child;\n                }\n                return child;\n            })}\n        </>\n    );\n}\n"],"mappings":"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"}